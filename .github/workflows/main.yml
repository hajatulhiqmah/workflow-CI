name: ML Pipeline CI

# Trigger workflow setiap kali ada push ke branch main
on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-and-run:
    runs-on: ubuntu-latest

    steps:
      # Langkah 1: Checkout kode dari repositori
      - name: Checkout repository
        uses: actions/checkout@v4

      # Langkah 2: Menyiapkan Miniconda (untuk environment)
      - name: Set up Python 3.9 with Conda
        uses: conda-incubator/setup-miniconda@v2
        with:
          python-version: 3.9
          environment-file: MLProject/conda.yaml # Otomatis membuat env dari file conda.yaml
          activate-environment: mlproject-heart-env # Nama env dari conda.yaml
          auto-activate-base: false

      # Langkah 3: Menjalankan MLflow Project (Memenuhi Kriteria Basic)
      #
      # Kita harus menggunakan 'shell: bash -l {0}' agar conda aktif
      - name: ðŸš€ Run MLflow Project (Basic)
        shell: bash -l {0}
        # Mengatur environment variables agar MLflow log ke DagsHub
        env:
          MLFLOW_TRACKING_URI: ${{ secrets.MLFLOW_TRACKING_URI }}
          MLFLOW_TRACKING_USERNAME: ${{ secrets.MLFLOW_TRACKING_USERNAME }}
          MLFLOW_TRACKING_PASSWORD: ${{ secrets.MLFLOW_TRACKING_PASSWORD }}
        run: |
          conda activate mlproject-heart-env
          mlflow run . --experiment-name "CI-Workflow-Run"

      # --- TAHAP SKILLED: Menyimpan Artefak ---
      #
      # Kita upload folder mlruns lokal yang dibuat oleh runner GitHub
      # sebagai bukti artefak (selain yang sudah di-log ke DagsHub)
      - name: ðŸ“¦ Upload local mlruns artifact (Skilled)
        if: success() # Hanya berjalan jika langkah sebelumnya sukses
        uses: actions/upload-artifact@v4
        with:
          name: mlruns-local-artifact
          path: mlruns/
